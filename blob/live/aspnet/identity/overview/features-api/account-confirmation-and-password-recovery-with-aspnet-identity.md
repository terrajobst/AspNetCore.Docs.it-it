---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: "Account di conferma e il recupero della Password con identità di ASP.NET (c#) | Documenti Microsoft"
author: HaoK
description: "Prima di eseguire questa esercitazione che è necessario completare prima creare un'app web di ASP.NET MVC 5 sicura con l'accesso, la reimpostazione di posta elettronica di conferma e la password. In questa esercitazione..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/26/2015
ms.topic: article
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 5fa7b6227eb88aa6766ab8776bc8a3cc1111b942
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 11/10/2017
---
<a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="510ce-104">La conferma dell'account e Password di ripristino con identità di ASP.NET (c#)</span><span class="sxs-lookup"><span data-stu-id="510ce-104">Account Confirmation and Password Recovery with ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="510ce-105">da [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="510ce-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="510ce-106">Prima di eseguire questa esercitazione è necessario completare [creare un'app web di ASP.NET MVC 5 sicura con l'accesso, la reimpostazione di posta elettronica di conferma e la password](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="510ce-106">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="510ce-107">In questa esercitazione contiene ulteriori dettagli e viene illustrato come impostare la posta elettronica per la conferma dell'account locale e consentire agli utenti di reimpostare la password dimenticata in ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="510ce-107">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span> <span data-ttu-id="510ce-108">In questo articolo è stato scritto dal Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung e Suhas Joshi.</span><span class="sxs-lookup"><span data-stu-id="510ce-108">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="510ce-109">L'esempio di NuGet è stata scritta principalmente da Hao Kung.</span><span class="sxs-lookup"><span data-stu-id="510ce-109">The NuGet sample was written primarily by Hao Kung.</span></span>


<span data-ttu-id="510ce-110">Un account utente locale richiede all'utente di creare una password per l'account e password verrà memorizzata () nell'app web.</span><span class="sxs-lookup"><span data-stu-id="510ce-110">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="510ce-111">Identità di ASP.NET supporta anche gli account di social networking, che non richiedono all'utente di creare una password per l'app.</span><span class="sxs-lookup"><span data-stu-id="510ce-111">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="510ce-112">[Account social](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) utilizzare una terza parte (ad esempio Google, Twitter, Facebook o Microsoft) per autenticare gli utenti.</span><span class="sxs-lookup"><span data-stu-id="510ce-112">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook or Microsoft) to authenticate users.</span></span> <span data-ttu-id="510ce-113">Questo argomento vengono illustrate le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="510ce-113">This topic covers the following:</span></span>

- <span data-ttu-id="510ce-114">[Creare un'applicazione MVC ASP.NET](#createMvc) ed esplorare le funzionalità di ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="510ce-114">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="510ce-115">Compilazione dell'esempio di identità</span><span class="sxs-lookup"><span data-stu-id="510ce-115">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="510ce-116">Impostare la conferma tramite posta elettronica</span><span class="sxs-lookup"><span data-stu-id="510ce-116">Set up email confirmation</span></span>](#email)

<span data-ttu-id="510ce-117">Nuovi utenti di registrare i relativi alias di posta elettronica, che consente di creare un account locale.</span><span class="sxs-lookup"><span data-stu-id="510ce-117">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="510ce-118">Fare clic sul pulsante registro invia un messaggio di posta elettronica di conferma contenente un token di convalida per l'indirizzo di posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="510ce-118">Clicking the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="510ce-119">L'utente viene inviato un messaggio di posta elettronica con un token di conferma per il proprio account.</span><span class="sxs-lookup"><span data-stu-id="510ce-119">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="510ce-120">Facendo clic sul collegamento di conferma dell'account.</span><span class="sxs-lookup"><span data-stu-id="510ce-120">Clicking the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="510ce-121">Ripristino o la reimpostazione della password</span><span class="sxs-lookup"><span data-stu-id="510ce-121">Password recovery/reset</span></span>

<span data-ttu-id="510ce-122">Gli utenti locali che dimenticano la password possono avere un token di sicurezza inviato al proprio account di posta elettronica, che consente di reimpostare la password.</span><span class="sxs-lookup"><span data-stu-id="510ce-122">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="510ce-123">L'utente riceverà presto un messaggio di posta elettronica con un collegamento che consente loro di reimpostazione della password.</span><span class="sxs-lookup"><span data-stu-id="510ce-123">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="510ce-124">Facendo clic sul collegamento giungeranno alla pagina di reimpostazione.</span><span class="sxs-lookup"><span data-stu-id="510ce-124">Clicking the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="510ce-125">Fare clic su di **reimpostare** pulsante confermare la password è stata reimpostata.</span><span class="sxs-lookup"><span data-stu-id="510ce-125">Clicking the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="510ce-126">Creare un'app Web ASP.NET</span><span class="sxs-lookup"><span data-stu-id="510ce-126">Create an ASP.NET Web app</span></span>

<span data-ttu-id="510ce-127">Avviare l'installazione ed eseguendo [Visual Studio Express 2013 per Web](https://go.microsoft.com/fwlink/?LinkId=299058) o [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span><span class="sxs-lookup"><span data-stu-id="510ce-127">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="510ce-128">Installazione di Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="510ce-128">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="510ce-129">Avviso: È necessario installare Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) per completare questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="510ce-129">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>


1. <span data-ttu-id="510ce-130">Creare un nuovo progetto Web ASP.NET e selezionare il modello MVC.</span><span class="sxs-lookup"><span data-stu-id="510ce-130">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="510ce-131">Web Form supporta anche ASP.NET Identity, pertanto è possibile attenersi alla procedura simile in un'app di web form.</span><span class="sxs-lookup"><span data-stu-id="510ce-131">Web Forms also supports ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="510ce-132">Lasciare l'autenticazione predefinita come **singoli account utente di**.</span><span class="sxs-lookup"><span data-stu-id="510ce-132">Leave the default authentication as **Individual User Accounts**.</span></span>
3. <span data-ttu-id="510ce-133">Eseguire l'app, fare clic su di **registrare** collegare e registrare un utente.</span><span class="sxs-lookup"><span data-stu-id="510ce-133">Run the app, click the **Register** link and register a user.</span></span> <span data-ttu-id="510ce-134">A questo punto, la convalida sola nel messaggio di posta elettronica è con il [[EmailAddress]](https://msdn.microsoft.com/en-us/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attributo.</span><span class="sxs-lookup"><span data-stu-id="510ce-134">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/en-us/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="510ce-135">In Esplora Server, passare a **dati Connections\DefaultConnection\Tables\AspNetUsers**fare clic destro del mouse e selezionare **Apri definizione tabella**.</span><span class="sxs-lookup"><span data-stu-id="510ce-135">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span>

    <span data-ttu-id="510ce-136">La figura seguente mostra il `AspNetUsers` dello schema:</span><span class="sxs-lookup"><span data-stu-id="510ce-136">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="510ce-137">Fare clic con il pulsante destro sul **AspNetUsers** tabella e selezionare **Mostra dati tabella**.</span><span class="sxs-lookup"><span data-stu-id="510ce-137">Right click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
 <span data-ttu-id="510ce-138">A questo punto il messaggio di posta elettronica non è stato confermato.</span><span class="sxs-lookup"><span data-stu-id="510ce-138">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="510ce-139">L'archivio di dati predefinito per ASP.NET Identity è Entity Framework, ma è possibile configurarlo per utilizzare altri archivi dati e per aggiungere altri campi.</span><span class="sxs-lookup"><span data-stu-id="510ce-139">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="510ce-140">Vedere [risorse aggiuntive](#addRes) sezione alla fine di questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="510ce-140">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="510ce-141">Il [classe di avvio OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) viene chiamato quando l'app viene avviata e richiama il `ConfigureAuth` metodo *App\_Start\Startup.Auth.cs*, Configura la pipeline OWIN che inizializza ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="510ce-141">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="510ce-142">Esaminare il `ConfigureAuth` metodo.</span><span class="sxs-lookup"><span data-stu-id="510ce-142">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="510ce-143">Ogni `CreatePerOwinContext` chiamata registra un callback (salvato nel `OwinContext`) che verrà chiamato una volta per ogni richiesta per creare un'istanza del tipo specificato.</span><span class="sxs-lookup"><span data-stu-id="510ce-143">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="510ce-144">È possibile impostare un punto di interruzione nel costruttore e `Create` il metodo di ogni tipo (`ApplicationDbContext, ApplicationUserManager`) e verificare che vengono chiamati su ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="510ce-144">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="510ce-145">Un'istanza di `ApplicationDbContext` e `ApplicationUserManager` viene archiviato nel contesto di OWIN, è possibile accedere in tutta l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="510ce-145">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="510ce-146">ASP.NET Identity hook nella pipeline OWIN tramite il middleware di cookie.</span><span class="sxs-lookup"><span data-stu-id="510ce-146">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="510ce-147">Per ulteriori informazioni, vedere [Per la gestione della durata richiesta per la classe UserManager in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="510ce-147">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="510ce-148">Quando si modifica il profilo di sicurezza, un indicatore di sicurezza verrà generato e archiviato nel `SecurityStamp` campo il *AspNetUsers* tabella.</span><span class="sxs-lookup"><span data-stu-id="510ce-148">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="510ce-149">Si noti che il `SecurityStamp` campo è diverso dal cookie di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="510ce-149">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="510ce-150">Il cookie di sicurezza non verrà memorizzato nel `AspNetUsers` tabella (o qualsiasi altro nel database di identità).</span><span class="sxs-lookup"><span data-stu-id="510ce-150">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="510ce-151">Il token del cookie di sicurezza è autofirmato usando [DPAPI](https://msdn.microsoft.com/en-us/library/system.security.cryptography.protecteddata.aspx) e viene creato con il `UserId, SecurityStamp` e informazioni sull'ora di scadenza.</span><span class="sxs-lookup"><span data-stu-id="510ce-151">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/en-us/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="510ce-152">Middleware del cookie controlla il cookie a ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="510ce-152">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="510ce-153">Il `SecurityStampValidator` metodo il `Startup` classe raggiungono il database e controlla periodicamente, indicatore di sicurezza come specificato con il `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="510ce-153">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="510ce-154">Questo errore si verifica solo ogni 30 minuti (in questo esempio) a meno che non si modifica il profilo di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="510ce-154">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="510ce-155">L'intervallo di 30 minuti è stato scelto per ridurre al minimo trip al database.</span><span class="sxs-lookup"><span data-stu-id="510ce-155">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="510ce-156">Vedere il [esercitazione di autenticazione a due fattori](index.md) per altri dettagli.</span><span class="sxs-lookup"><span data-stu-id="510ce-156">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="510ce-157">Per i commenti nel codice, il `UseCookieAuthentication` metodo supporta l'autenticazione dei cookie.</span><span class="sxs-lookup"><span data-stu-id="510ce-157">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="510ce-158">Il `SecurityStamp` codice associato e viene fornisce un ulteriore livello di sicurezza per l'app, quando si modifica la password, verrà registrato del browser eseguire l'accesso.</span><span class="sxs-lookup"><span data-stu-id="510ce-158">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="510ce-159">Il `SecurityStampValidator.OnValidateIdentity` metodo consente all'app convalidare il token di sicurezza quando l'utente effettua l'accesso, che viene utilizzato quando si modifica una password o l'account di accesso esterno.</span><span class="sxs-lookup"><span data-stu-id="510ce-159">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="510ce-160">Questo è necessario per garantire che tutti i token (cookie) generati con la vecchia password vengono invalidati.</span><span class="sxs-lookup"><span data-stu-id="510ce-160">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="510ce-161">Nel progetto di esempio, se si modifica la password di utenti, quindi un nuovo token viene generata per l'utente, vengono invalidati tutti i token precedenti e `SecurityStamp` campo viene aggiornato.</span><span class="sxs-lookup"><span data-stu-id="510ce-161">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="510ce-162">Il sistema di identità consentono di configurare l'app, quando viene modificato il profilo di sicurezza agli utenti (ad esempio, quando l'utente modifica la password o modifiche associata account di accesso (ad esempio da Facebook, Google, account Microsoft, e così via), l'utente è connesso da tutti istanze del browser.</span><span class="sxs-lookup"><span data-stu-id="510ce-162">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="510ce-163">Ad esempio, l'immagine seguente viene illustrato il [esempio Single Sign-Out](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, che consente all'utente di disconnettersi da tutte le istanze del browser (in questo caso, Internet Explorer, Firefox e Chrome) facendo clic su un pulsante.</span><span class="sxs-lookup"><span data-stu-id="510ce-163">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by clicking one button.</span></span> <span data-ttu-id="510ce-164">In alternativa, l'esempio consente di disconnettersi solo un'istanza specifica del browser.</span><span class="sxs-lookup"><span data-stu-id="510ce-164">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="510ce-165">Il [esempio Single Sign-Out](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app Mostra come identità di ASP.NET consente di rigenerare il token di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="510ce-165">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="510ce-166">Questo è necessario per garantire che tutti i token (cookie) generati con la vecchia password vengono invalidati.</span><span class="sxs-lookup"><span data-stu-id="510ce-166">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="510ce-167">Questa funzionalità fornisce un ulteriore livello di sicurezza per l'applicazione. Quando si modifica la password, verrà registrato il quale si accede a questa applicazione.</span><span class="sxs-lookup"><span data-stu-id="510ce-167">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="510ce-168">Il *App\_Start\IdentityConfig.cs* file contiene il `ApplicationUserManager`, `EmailService` e `SmsService` classi.</span><span class="sxs-lookup"><span data-stu-id="510ce-168">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="510ce-169">Il `EmailService` e `SmsService` classi ogni implementano la `IIdentityMessageService` interfaccia, in modo che si dispone di metodi comuni in ogni classe per configurare posta elettronica e SMS.</span><span class="sxs-lookup"><span data-stu-id="510ce-169">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="510ce-170">Sebbene questa esercitazione viene illustrato solo come aggiungere una notifica tramite posta elettronica tramite [SendGrid](http://sendgrid.com/), è possibile inviare tramite posta elettronica tramite SMTP e altri meccanismi.</span><span class="sxs-lookup"><span data-stu-id="510ce-170">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="510ce-171">Il `Startup` classe contiene inoltre una presentazione per la stampa per aggiungere gli account di accesso social (Facebook, Twitter e così via), vedere l'esercitazione [MVC 5 App con Facebook, Twitter, LinkedIn e Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) per altre informazioni.</span><span class="sxs-lookup"><span data-stu-id="510ce-171">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="510ce-172">Esaminare il `ApplicationUserManager` (classe), che contiene le informazioni sull'identità di utenti e configura le funzionalità seguenti:</span><span class="sxs-lookup"><span data-stu-id="510ce-172">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="510ce-173">Requisiti di complessità delle password.</span><span class="sxs-lookup"><span data-stu-id="510ce-173">Password strength requirements.</span></span>
- <span data-ttu-id="510ce-174">Blocco utente (tentativi e l'ora).</span><span class="sxs-lookup"><span data-stu-id="510ce-174">User lock out (attempts and time).</span></span>
- <span data-ttu-id="510ce-175">Autenticazione a due fattori (2FA).</span><span class="sxs-lookup"><span data-stu-id="510ce-175">Two-factor authentication (2FA).</span></span> <span data-ttu-id="510ce-176">Descritti 2FA e SMS in un'altra esercitazione.</span><span class="sxs-lookup"><span data-stu-id="510ce-176">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="510ce-177">Associazione di posta e dei servizi SMS.</span><span class="sxs-lookup"><span data-stu-id="510ce-177">Hooking up the email and SMS services.</span></span> <span data-ttu-id="510ce-178">(Un'altra esercitazione verrà descritta SMS).</span><span class="sxs-lookup"><span data-stu-id="510ce-178">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="510ce-179">Il `ApplicationUserManager` classe deriva dal modello generico `UserManager<ApplicationUser>` classe.</span><span class="sxs-lookup"><span data-stu-id="510ce-179">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="510ce-180">`ApplicationUser`deriva da [IdentityUser](https://msdn.microsoft.com/en-us/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="510ce-180">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/en-us/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="510ce-181">`IdentityUser`deriva da generica `IdentityUser` classe:</span><span class="sxs-lookup"><span data-stu-id="510ce-181">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="510ce-182">Le proprietà precedente coincidano con le proprietà di `AspNetUsers` tabella, illustrata in precedenza.</span><span class="sxs-lookup"><span data-stu-id="510ce-182">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="510ce-183">Gli argomenti generici in `IUser` consentono di derivare una classe di utilizzo di tipi diversi per la chiave primaria.</span><span class="sxs-lookup"><span data-stu-id="510ce-183">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="510ce-184">Vedere il [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) esempio in cui viene illustrato come modificare la chiave primaria da stringa a int o GUID.</span><span class="sxs-lookup"><span data-stu-id="510ce-184">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="510ce-185">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="510ce-185">ApplicationUser</span></span>

<span data-ttu-id="510ce-186">`ApplicationUser`(`public class ApplicationUserManager : UserManager<ApplicationUser>`) è definito in *Models\IdentityModels.cs* come:</span><span class="sxs-lookup"><span data-stu-id="510ce-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="510ce-187">Genera il codice evidenziato sopra un [ClaimsIdentity](https://msdn.microsoft.com/en-us/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="510ce-187">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/en-us/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="510ce-188">ASP.NET Identity e OWIN Cookie di autenticazione basata sulle attestazioni, pertanto il framework richiede che l'app per generare un `ClaimsIdentity` per l'utente.</span><span class="sxs-lookup"><span data-stu-id="510ce-188">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="510ce-189">`ClaimsIdentity`contiene informazioni su tutte le attestazioni per l'utente, ad esempio il nome dell'utente, l'età e i ruoli utente appartiene.</span><span class="sxs-lookup"><span data-stu-id="510ce-189">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="510ce-190">È anche possibile aggiungere ulteriori attestazioni per l'utente in questa fase.</span><span class="sxs-lookup"><span data-stu-id="510ce-190">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="510ce-191">OWIN `AuthenticationManager.SignIn` metodo passa il `ClaimsIdentity` e accede l'utente:</span><span class="sxs-lookup"><span data-stu-id="510ce-191">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="510ce-192">[App di MVC 5 con Facebook, Twitter, LinkedIn e Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) viene illustrato come è possibile aggiungere proprietà aggiuntive per la `ApplicationUser` classe.</span><span class="sxs-lookup"><span data-stu-id="510ce-192">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="510ce-193">Conferma tramite posta elettronica</span><span class="sxs-lookup"><span data-stu-id="510ce-193">Email confirmation</span></span>

<span data-ttu-id="510ce-194">È consigliabile verificare il messaggio di posta elettronica un nuovo utente registrarsi per verificare che non rappresentano un altro utente (vale a dire, è ancora stato registrato con un altro messaggio di posta elettronica).</span><span class="sxs-lookup"><span data-stu-id="510ce-194">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="510ce-195">Si supponga di un forum di discussione, si desidera impedire `"bob@example.com"` tramite la registrazione come `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="510ce-195">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="510ce-196">Senza conferma tramite posta elettronica, `"joe@contoso.com"` Impossibile ricevere la posta elettronica indesiderato dall'app.</span><span class="sxs-lookup"><span data-stu-id="510ce-196">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="510ce-197">Si supponga che Bob accidentalmente registrato come `"bib@example.com"` e non veniva notare, ha non sarebbe in grado di utilizzare password Ripristina perché l'app non ha il suo messaggio di posta elettronica corretto.</span><span class="sxs-lookup"><span data-stu-id="510ce-197">Suppose Bob accidently registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="510ce-198">Conferma tramite posta elettronica fornisce a livello di protezione limitato da BOT e non offre protezione da spamming determinato, hanno molti alias di posta elettronica di lavoro che possono utilizzare per registrare. Nell'esempio seguente, l'utente non sarà possibile cambiare la password, fino a quando non è stato confermato l'account (da esse facendo clic su un collegamento di conferma ricevuto in siano registrati con l'account di posta elettronica.) È possibile applicare questo flusso di lavoro in altri scenari, ad esempio l'invio di un collegamento per confermare e reimpostare la password al nuovo account creato dall'amministratore, l'invio all'utente un messaggio di posta elettronica quando vengono modificati il proprio profilo e così via.</span><span class="sxs-lookup"><span data-stu-id="510ce-198">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them clicking on a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="510ce-199">In genere si desidera impedire agli utenti di nuovo di registrazione dei dati del sito web prima che siano stati confermati tramite posta elettronica, un SMS o un altro meccanismo.</span><span class="sxs-lookup"><span data-stu-id="510ce-199">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="building-a-more-complete-sample"></a><span data-ttu-id="510ce-200">La creazione di un esempio più completo</span><span class="sxs-lookup"><span data-stu-id="510ce-200">Building a more complete sample</span></span>

<span data-ttu-id="510ce-201">In questa sezione si userà NuGet per scaricare un esempio più completo, che si opererà con.</span><span class="sxs-lookup"><span data-stu-id="510ce-201">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="510ce-202">Creare un nuovo ***vuoto*** progetto Web ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="510ce-202">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="510ce-203">Nella Console di gestione pacchetti, immettere quanto segue i comandi seguenti:</span><span class="sxs-lookup"><span data-stu-id="510ce-203">In the Package Manager Console, enter the following the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

 <span data-ttu-id="510ce-204">In questa esercitazione si userà [SendGrid](http://sendgrid.com/) per inviare posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="510ce-204">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="510ce-205">Il `Identity.Samples` pacchetto viene installato il codice che verrà utilizzato con.</span><span class="sxs-lookup"><span data-stu-id="510ce-205">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="510ce-206">Impostare il [progetto utilizzare SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="510ce-206">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="510ce-207">Creazione di account locali di test eseguendo l'app, fare clic di **registrare** il collegamento e registrazione del modulo di registrazione.</span><span class="sxs-lookup"><span data-stu-id="510ce-207">Test local account creation by running the app, clicking on the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="510ce-208">Scegliere il collegamento di posta elettronica, demo che simula una conferma tramite posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="510ce-208">Click the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="510ce-209">Rimuovere il codice di conferma demo collegamento e-mail tratto dall'esempio (il `ViewBag.Link` codice nel controller di account.</span><span class="sxs-lookup"><span data-stu-id="510ce-209">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="510ce-210">Vedere il `DisplayEmail` e `ForgotPasswordConfirmation` metodi di azione e visualizzazioni razor).</span><span class="sxs-lookup"><span data-stu-id="510ce-210">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!NOTE]
> <span data-ttu-id="510ce-211">Avviso: Se si modifica una qualsiasi delle impostazioni di sicurezza in questo esempio, le applicazioni di produzione saranno necessario eseguire un controllo di sicurezza che chiama in modo esplicito le modifiche apportate.</span><span class="sxs-lookup"><span data-stu-id="510ce-211">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="510ce-212">Esaminare il codice nell'App\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="510ce-212">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="510ce-213">L'esempio viene illustrato come creare un account e aggiungerlo al *Admin* ruolo.</span><span class="sxs-lookup"><span data-stu-id="510ce-213">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="510ce-214">Messaggio di posta elettronica nell'esempio è necessario sostituire con il messaggio di posta elettronica che verrà utilizzato per l'account amministratore.</span><span class="sxs-lookup"><span data-stu-id="510ce-214">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="510ce-215">Il modo più semplice subito a creare un account amministratore è a livello di codice nel `Seed` metodo.</span><span class="sxs-lookup"><span data-stu-id="510ce-215">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="510ce-216">Ci auguriamo che in futuro uno strumento che consente di creare e amministrare utenti e ruoli.</span><span class="sxs-lookup"><span data-stu-id="510ce-216">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="510ce-217">Nell'esempio di codice consentono di creare e gestire utenti e ruoli, ma è necessario innanzitutto un account degli amministratori per eseguire i ruoli e le pagine di amministrazione di utente.</span><span class="sxs-lookup"><span data-stu-id="510ce-217">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="510ce-218">In questo esempio, l'account amministratore viene creato quando viene effettuato il seeding del database.</span><span class="sxs-lookup"><span data-stu-id="510ce-218">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="510ce-219">Modificare la password e modificare il nome a un account in cui è possibile ricevere notifiche tramite posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="510ce-219">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="510ce-220">Sicurezza - archivio mai i dati sensibili nel codice sorgente.</span><span class="sxs-lookup"><span data-stu-id="510ce-220">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="510ce-221">Come accennato in precedenza, il `app.CreatePerOwinContext` chiamata nella classe di avvio aggiunge i callback per la `Create` metodo le app DB contenuto, gestione e il ruolo Gestione classi utente.</span><span class="sxs-lookup"><span data-stu-id="510ce-221">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="510ce-222">Chiamate di pipeline OWIN il `Create` metodo su queste classi per ogni richiesta e archivia il contesto per ogni classe.</span><span class="sxs-lookup"><span data-stu-id="510ce-222">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="510ce-223">Il controller di account espone il gestore utenti dal contesto HTTP (che contiene il contesto OWIN):</span><span class="sxs-lookup"><span data-stu-id="510ce-223">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="510ce-224">Quando un utente registra un account locale, il `HTTP Post Register` metodo viene chiamato:</span><span class="sxs-lookup"><span data-stu-id="510ce-224">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="510ce-225">Il codice precedente utilizza i dati del modello per creare un nuovo account utente utilizzando il messaggio di posta elettronica e la password immessa.</span><span class="sxs-lookup"><span data-stu-id="510ce-225">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="510ce-226">Se l'alias di posta elettronica si trova nell'archivio dati, la creazione di account non riesce e viene visualizzato nuovamente il modulo.</span><span class="sxs-lookup"><span data-stu-id="510ce-226">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="510ce-227">Il `GenerateEmailConfirmationTokenAsync` metodo crea un token di conferma sicura e viene memorizzato nell'archivio dati di ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="510ce-227">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="510ce-228">Il [Action](https://msdn.microsoft.com/en-us/library/dd505232(v=vs.118).aspx) metodo crea un collegamento contenente il `UserId` e token di conferma.</span><span class="sxs-lookup"><span data-stu-id="510ce-228">The [Url.Action](https://msdn.microsoft.com/en-us/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="510ce-229">Questo collegamento viene quindi inviato tramite posta elettronica dell'utente, l'utente può fare clic sul collegamento nella propria app di posta elettronica per confermare il proprio account.</span><span class="sxs-lookup"><span data-stu-id="510ce-229">This link is then emailed to the user, the user can click on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="510ce-230">Impostare la conferma tramite posta elettronica</span><span class="sxs-lookup"><span data-stu-id="510ce-230">Set up email confirmation</span></span>

<span data-ttu-id="510ce-231">Passare al [pagina di iscrizione Azure SendGrid](https://azure.microsoft.com/en-us/gallery/store/sendgrid/sendgrid-azure/) e registrare l'account gratuito.</span><span class="sxs-lookup"><span data-stu-id="510ce-231">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/en-us/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="510ce-232">Aggiungere codice analogo al seguente per configurare SendGrid:</span><span class="sxs-lookup"><span data-stu-id="510ce-232">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="510ce-233">Client di posta elettronica è spesso accettare solo messaggi di testo (non HTML).</span><span class="sxs-lookup"><span data-stu-id="510ce-233">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="510ce-234">È necessario fornire il messaggio in testo e HTML.</span><span class="sxs-lookup"><span data-stu-id="510ce-234">You should provide the message in text and HTML.</span></span> <span data-ttu-id="510ce-235">Nell'esempio SendGrid, questa operazione viene eseguita con il `myMessage.Text` e `myMessage.Html` nel codice sopra riportato.</span><span class="sxs-lookup"><span data-stu-id="510ce-235">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="510ce-236">Il codice seguente viene illustrato come inviare tramite posta elettronica di [MailMessage](https://msdn.microsoft.com/en-us/library/system.net.mail.mailmessage.aspx) classe where `message.Body` restituisce solo il collegamento.</span><span class="sxs-lookup"><span data-stu-id="510ce-236">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/en-us/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="510ce-237">Sicurezza - archivio mai i dati sensibili nel codice sorgente.</span><span class="sxs-lookup"><span data-stu-id="510ce-237">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="510ce-238">L'account e le credenziali vengono archiviate in appSetting.</span><span class="sxs-lookup"><span data-stu-id="510ce-238">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="510ce-239">In Azure, è possibile archiviare questi valori in modo sicuro nel  **[configura](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)**  scheda nel portale di Azure.</span><span class="sxs-lookup"><span data-stu-id="510ce-239">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="510ce-240">Vedere [procedure consigliate per la distribuzione delle password e altri dati sensibili su ASP.NET e in Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="510ce-240">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="510ce-241">Immettere le credenziali SendGrid, eseguire l'app, registrazione con un alias di posta elettronica può fare clic sul collegamento di conferma nel messaggio di posta elettronica.</span><span class="sxs-lookup"><span data-stu-id="510ce-241">Enter your SendGrid credentials, run the app, register with an email alias can click the confirm link in your email.</span></span> <span data-ttu-id="510ce-242">Per informazioni su come eseguire questa operazione con il [Outlook.com](http://outlook.com) account di posta elettronica, vedere di John Atten [c# configurazione SMTP per l'Host SMTP Outlook.Com](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) e il suo[identità ASP.NET 2.0: convalida dell'impostazione di Account e l'autorizzazione a due fattori](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) post.</span><span class="sxs-lookup"><span data-stu-id="510ce-242">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="510ce-243">Una volta che un utente fa clic il **registrare** pulsante al relativo indirizzo di posta elettronica viene inviato un messaggio di conferma contenente un token di convalida.</span><span class="sxs-lookup"><span data-stu-id="510ce-243">Once a user clicks the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="510ce-244">L'utente viene inviato un messaggio di posta elettronica con un token di conferma per il proprio account.</span><span class="sxs-lookup"><span data-stu-id="510ce-244">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="510ce-245">Esaminare il codice</span><span class="sxs-lookup"><span data-stu-id="510ce-245">Examine the code</span></span>

<span data-ttu-id="510ce-246">Nel codice seguente viene illustrato il metodo `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="510ce-246">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="510ce-247">Il metodo non riesce senza avvisare se il messaggio di posta elettronica utente non è stato confermato.</span><span class="sxs-lookup"><span data-stu-id="510ce-247">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="510ce-248">Se è stato registrato un errore per un indirizzo di posta elettronica non valido, gli utenti malintenzionati è possibile utilizzare tali informazioni per trovare l'ID utente valido (alias di posta elettronica) agli attacchi.</span><span class="sxs-lookup"><span data-stu-id="510ce-248">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="510ce-249">Il codice seguente illustra il `ConfirmEmail` metodo nel controller di account che viene chiamato quando l'utente fa clic sul collegamento di conferma nel messaggio di posta elettronica inviato a essi:</span><span class="sxs-lookup"><span data-stu-id="510ce-249">The following code shows the `ConfirmEmail` method in the account controller that is called when the user clicks the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="510ce-250">Dopo che è stato utilizzato un token di password dimenticata, viene invalidato.</span><span class="sxs-lookup"><span data-stu-id="510ce-250">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="510ce-251">La modifica di codice seguente il `Create` (metodo) (nel *App\_Start\IdentityConfig.cs* file) imposta il token scadrà fra 3 ore.</span><span class="sxs-lookup"><span data-stu-id="510ce-251">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="510ce-252">Con il codice precedente, la password dimenticata e i token di conferma tramite posta elettronica scadrà in 3 ore.</span><span class="sxs-lookup"><span data-stu-id="510ce-252">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="510ce-253">Il valore predefinito `TokenLifespan` è un giorno.</span><span class="sxs-lookup"><span data-stu-id="510ce-253">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="510ce-254">Il codice seguente viene illustrato il metodo di conferma tramite posta elettronica:</span><span class="sxs-lookup"><span data-stu-id="510ce-254">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="510ce-255">Per rendere la tua app più sicura, ASP.NET Identity supporta autenticazione a due fattori (2FA).</span><span class="sxs-lookup"><span data-stu-id="510ce-255">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="510ce-256">Vedere [identità di ASP.NET 2.0: impostazione di convalida dell'Account e l'autorizzazione a due fattori](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) da John Atten.</span><span class="sxs-lookup"><span data-stu-id="510ce-256">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="510ce-257">Anche se è possibile impostare il blocco degli account per i tentativi non riusciti password di account di accesso, tale approccio rende sensibili per l'account di accesso [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) blocchi.</span><span class="sxs-lookup"><span data-stu-id="510ce-257">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="510ce-258">È consigliabile che utilizzare il blocco degli account solo con 2FA.</span><span class="sxs-lookup"><span data-stu-id="510ce-258">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="510ce-259">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="510ce-259">Additional Resources</span></span>

- [<span data-ttu-id="510ce-260">Panoramica dei provider di archiviazione personalizzato per l'identità ASP.NET</span><span class="sxs-lookup"><span data-stu-id="510ce-260">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="510ce-261">[App di MVC 5 con Facebook, Twitter, LinkedIn e Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) viene inoltre illustrato come aggiungere informazioni sul profilo nella tabella gli utenti.</span><span class="sxs-lookup"><span data-stu-id="510ce-261">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="510ce-262">[ASP.NET MVC e identità 2.0: nozioni di base](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) da John Atten.</span><span class="sxs-lookup"><span data-stu-id="510ce-262">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="510ce-263">Introduzione all'identità di ASP.NET</span><span class="sxs-lookup"><span data-stu-id="510ce-263">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="510ce-264">[Annuncio RTM di ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) da Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="510ce-264">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
