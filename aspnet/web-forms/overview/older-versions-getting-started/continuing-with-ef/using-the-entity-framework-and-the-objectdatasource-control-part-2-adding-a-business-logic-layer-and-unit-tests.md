---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: 'Utilizzo di Entity Framework 4.0 e il controllo ObjectDataSource, parte 2: aggiunta di un livello di logica di Business e gli Unit test | Documenti Microsoft'
author: tdykstra
description: Questa serie di esercitazioni compila nell'applicazione web di Contoso University creato da introduttiva la serie di esercitazioni di Entity Framework 4.0. I...
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/26/2011
ms.topic: article
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: df37acd8901b457f7887afe767d42d53e45e4815
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/24/2018
---
<a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="b6f64-104">Utilizzo di Entity Framework 4.0 e il controllo ObjectDataSource, parte 2: aggiunta di un livello di logica di Business e gli Unit test</span><span class="sxs-lookup"><span data-stu-id="b6f64-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>
====================
<span data-ttu-id="b6f64-105">Da [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="b6f64-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="b6f64-106">Questa serie di esercitazioni si basa sull'applicazione web di Contoso University creando il [introduzione di Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) serie di esercitazioni.</span><span class="sxs-lookup"><span data-stu-id="b6f64-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="b6f64-107">Se non ha completato le esercitazioni precedenti, come punto di partenza per questa esercitazione è possibile [scaricare l'applicazione](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) che consente di creare.</span><span class="sxs-lookup"><span data-stu-id="b6f64-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="b6f64-108">È anche possibile [scaricare l'applicazione](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) creati tramite la serie di esercitazioni completo.</span><span class="sxs-lookup"><span data-stu-id="b6f64-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="b6f64-109">Nel caso di problemi con le esercitazioni, è possibile registrarli per il [forum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="b6f64-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="b6f64-110">Nell'esercitazione precedente è stato creato un'applicazione web a più livelli tramite Entity Framework e `ObjectDataSource` controllo.</span><span class="sxs-lookup"><span data-stu-id="b6f64-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="b6f64-111">In questa esercitazione viene illustrato come aggiungere logica di business, mantenendo il livello di logica di business (BLL) e il livello di accesso ai dati (DAL) separato e viene illustrato come creare unit test automatizzati per il livello Business LOGIC.</span><span class="sxs-lookup"><span data-stu-id="b6f64-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="b6f64-112">In questa esercitazione si completeranno le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="b6f64-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="b6f64-113">Creare un repository di interfaccia che dichiara i metodi di accesso ai dati, che è necessario.</span><span class="sxs-lookup"><span data-stu-id="b6f64-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="b6f64-114">Implementare l'interfaccia del repository nella classe del repository.</span><span class="sxs-lookup"><span data-stu-id="b6f64-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="b6f64-115">Creare una classe di logica di business che chiama la classe di repository per eseguire funzioni di accesso ai dati.</span><span class="sxs-lookup"><span data-stu-id="b6f64-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="b6f64-116">Connettere il `ObjectDataSource` controllo alla classe della logica di business anziché per la classe di repository.</span><span class="sxs-lookup"><span data-stu-id="b6f64-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="b6f64-117">Creare un progetto di unit test e una classe di repository che usa raccolte in memoria per il proprio archivio dati.</span><span class="sxs-lookup"><span data-stu-id="b6f64-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="b6f64-118">Creare uno unit test per la logica di business che si desidera aggiungere alla classe della logica di business, quindi esegue il test e visualizzarlo esito negativo.</span><span class="sxs-lookup"><span data-stu-id="b6f64-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="b6f64-119">Implementare la logica di business nella classe della logica di business, quindi eseguire nuovamente l'unità di test e visualizzarlo passare.</span><span class="sxs-lookup"><span data-stu-id="b6f64-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="b6f64-120">Si utilizzerà il *Departments.aspx* e *DepartmentsAdd.aspx* pagine creato nell'esercitazione precedente.</span><span class="sxs-lookup"><span data-stu-id="b6f64-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="b6f64-121">Creazione di un'interfaccia del Repository</span><span class="sxs-lookup"><span data-stu-id="b6f64-121">Creating a Repository Interface</span></span>

<span data-ttu-id="b6f64-122">Inizierai creando l'interfaccia del repository.</span><span class="sxs-lookup"><span data-stu-id="b6f64-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="b6f64-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="b6f64-124">Nel *DAL* cartella, creare un nuovo file di classe, denominarlo *ISchoolRepository.cs*e sostituire il codice esistente con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="b6f64-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="b6f64-125">L'interfaccia definisce un metodo per ogni il CRUD (create, leggere, aggiornare ed eliminare) i metodi che è stato creato nella classe del repository.</span><span class="sxs-lookup"><span data-stu-id="b6f64-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="b6f64-126">Nel `SchoolRepository` classe *SchoolRepository.cs*, indicare che questa classe implementa il `ISchoolRepository` interfaccia:</span><span class="sxs-lookup"><span data-stu-id="b6f64-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="b6f64-127">Creazione di una classe di logica di Business</span><span class="sxs-lookup"><span data-stu-id="b6f64-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="b6f64-128">Successivamente, si creerà la classe di logica di business.</span><span class="sxs-lookup"><span data-stu-id="b6f64-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="b6f64-129">Questo caso, in modo che sia possibile aggiungere logica di business che verrà eseguita dal `ObjectDataSource` controllare, anche se non si verrà eseguita che ancora.</span><span class="sxs-lookup"><span data-stu-id="b6f64-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="b6f64-130">Per il momento, solo la nuova classe di logica di business eseguirà le stesse operazioni CRUD che esegue il repository.</span><span class="sxs-lookup"><span data-stu-id="b6f64-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="b6f64-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="b6f64-132">Creare una nuova cartella e denominarla *BLL*.</span><span class="sxs-lookup"><span data-stu-id="b6f64-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="b6f64-133">(In un'applicazione reale, il livello di logica di business verrebbe in genere implementato come libreria di classi, ovvero un progetto separato, ma per rendere semplice l'esercitazione, classi BLL verranno conservate in una cartella di progetto.)</span><span class="sxs-lookup"><span data-stu-id="b6f64-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="b6f64-134">Nel *BLL* cartella, creare un nuovo file di classe, denominarlo *SchoolBL.cs*e sostituire il codice esistente con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="b6f64-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="b6f64-135">Questo codice crea gli stessi metodi CRUD che è stato illustrato in precedenza nella classe del repository, ma anziché accedere direttamente i metodi di Entity Framework, chiama il repository metodi della classe.</span><span class="sxs-lookup"><span data-stu-id="b6f64-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="b6f64-136">La variabile di classe che contiene un riferimento alla classe del repository è definita come un tipo di interfaccia e il codice che crea un'istanza della classe di repository è contenuto in due costruttori.</span><span class="sxs-lookup"><span data-stu-id="b6f64-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="b6f64-137">Il costruttore senza parametri da utilizzare per il `ObjectDataSource` controllo.</span><span class="sxs-lookup"><span data-stu-id="b6f64-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="b6f64-138">Crea un'istanza di `SchoolRepository` classe creata in precedenza.</span><span class="sxs-lookup"><span data-stu-id="b6f64-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="b6f64-139">L'altro costruttore consente qualsiasi codice che crea un'istanza della classe di logica di business di passare qualsiasi oggetto che implementa l'interfaccia del repository.</span><span class="sxs-lookup"><span data-stu-id="b6f64-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="b6f64-140">I metodi CRUD che chiamano la classe di repository e i due costruttori consentono di utilizzare la classe di logica di business con qualsiasi archivio dati back-end prescelto.</span><span class="sxs-lookup"><span data-stu-id="b6f64-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="b6f64-141">La classe di logica di business non è necessario essere a conoscenza di come la classe che viene chiamata rende persistenti i dati.</span><span class="sxs-lookup"><span data-stu-id="b6f64-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="b6f64-142">(Si tratta spesso *mancato riconoscimento della persistenza*.) Ciò facilita l'esecuzione di unit test, perché la classe di logica di business è possibile connettersi all'implementazione di un repository che vengono utilizzati come semplice come in memoria `List` raccolte per archiviare i dati.</span><span class="sxs-lookup"><span data-stu-id="b6f64-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="b6f64-143">Tecnicamente, gli oggetti entità sono ancora non persistenza, perché si è creata un'istanza da classi che ereditano da Entity Framework `EntityObject` classe.</span><span class="sxs-lookup"><span data-stu-id="b6f64-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="b6f64-144">Mancato riconoscimento della persistenza completa, è possibile utilizzare *plain old CLR Object*, o *POCOs*, al posto di oggetti da cui ereditare la `EntityObject` classe.</span><span class="sxs-lookup"><span data-stu-id="b6f64-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="b6f64-145">Utilizzando POCOs non rientra nell'ambito di questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="b6f64-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="b6f64-146">Per ulteriori informazioni, vedere [testabilità ed Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) nel sito Web MSDN.)</span><span class="sxs-lookup"><span data-stu-id="b6f64-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>


<span data-ttu-id="b6f64-147">Ora è possibile connettere il `ObjectDataSource` controlli per la logica di business classe invece che al repository e verificare che tutto funzioni come in precedenza.</span><span class="sxs-lookup"><span data-stu-id="b6f64-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="b6f64-148">In *Departments.aspx* e *DepartmentsAdd.aspx*, sostituire ogni occorrenza del `TypeName="ContosoUniversity.DAL.SchoolRepository"` a `TypeName="ContosoUniversity.BLL.SchoolBL`".</span><span class="sxs-lookup"><span data-stu-id="b6f64-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="b6f64-149">(Sono presenti quattro istanze in tutte.)</span><span class="sxs-lookup"><span data-stu-id="b6f64-149">(There are four instances in all.)</span></span>

<span data-ttu-id="b6f64-150">Eseguire il *Departments.aspx* e *DepartmentsAdd.aspx* pagine per verificare che funzionino ancora come in precedenza.</span><span class="sxs-lookup"><span data-stu-id="b6f64-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="b6f64-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="b6f64-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="b6f64-153">Creazione di un progetto di Unit Test e l'implementazione di Repository</span><span class="sxs-lookup"><span data-stu-id="b6f64-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="b6f64-154">Aggiungere un nuovo progetto alla soluzione utilizzando la **progetto di Test** , modello e specificare il nome `ContosoUniversity.Tests`.</span><span class="sxs-lookup"><span data-stu-id="b6f64-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="b6f64-155">Nel progetto di test, aggiungere un riferimento a `System.Data.Entity` e aggiungere un riferimento al progetto il `ContosoUniversity` progetto.</span><span class="sxs-lookup"><span data-stu-id="b6f64-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="b6f64-156">È ora possibile creare la classe di repository che si userà con unit test.</span><span class="sxs-lookup"><span data-stu-id="b6f64-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="b6f64-157">L'archivio dati per questo repository sarà all'interno della classe.</span><span class="sxs-lookup"><span data-stu-id="b6f64-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="b6f64-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="b6f64-159">Nel progetto di test, creare un nuovo file di classe, denominarlo *MockSchoolRepository.cs*e sostituire il codice esistente con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="b6f64-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="b6f64-160">Questa classe repository ha gli stessi metodi CRUD di quello che accede direttamente a Entity Framework, ma funzionano con `List` raccolte in memoria anziché con un database.</span><span class="sxs-lookup"><span data-stu-id="b6f64-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="b6f64-161">Questo rende più semplice per una classe di test impostare e convalidare gli unit test per la classe di logica di business.</span><span class="sxs-lookup"><span data-stu-id="b6f64-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="b6f64-162">Creazione di Unit test</span><span class="sxs-lookup"><span data-stu-id="b6f64-162">Creating Unit Tests</span></span>

<span data-ttu-id="b6f64-163">Il **Test** modello di progetto creata una classe stub di unit test e l'attività successiva consiste nella modifica di questa classe aggiungendo metodi di unit test per la logica di business che si desidera aggiungere alla classe della logica di business.</span><span class="sxs-lookup"><span data-stu-id="b6f64-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="b6f64-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="b6f64-165">Contoso University, qualsiasi singolo istruttore può essere solo l'amministratore di un singolo reparto ed è necessario aggiungere logica di business per applicare questa regola.</span><span class="sxs-lookup"><span data-stu-id="b6f64-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="b6f64-166">Si inizierà con aggiunta di test e l'esecuzione dei test per visualizzarli esito negativo.</span><span class="sxs-lookup"><span data-stu-id="b6f64-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="b6f64-167">Si verrà quindi aggiungere il codice e rieseguire i test, è previsto per visualizzarli passare.</span><span class="sxs-lookup"><span data-stu-id="b6f64-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="b6f64-168">Aprire il *UnitTest1.cs* file e aggiungere `using` istruzioni per i livelli di accesso ai dati e di logica di business creati nel progetto ContosoUniversity:</span><span class="sxs-lookup"><span data-stu-id="b6f64-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="b6f64-169">Sostituire il `TestMethod1` (metodo) con i metodi seguenti:</span><span class="sxs-lookup"><span data-stu-id="b6f64-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="b6f64-170">Il `CreateSchoolBL` metodo crea un'istanza della classe repository creato per il progetto, che viene quindi passato a una nuova istanza della classe della logica di business unit test.</span><span class="sxs-lookup"><span data-stu-id="b6f64-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="b6f64-171">Il metodo utilizza quindi la classe di logica di business per inserire tre reparti che è possibile utilizzare nei metodi di test.</span><span class="sxs-lookup"><span data-stu-id="b6f64-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="b6f64-172">I metodi di test è verificare che la classe di logica di business genera un'eccezione se un utente tenta di inserire una nuova categoria con lo stesso tipo di amministratore una categoria esistente oppure se un utente tenta di aggiornare l'amministratore di un reparto mediante l'impostazione per l'ID di una persona chi è già l'amministratore di un altro reparto.</span><span class="sxs-lookup"><span data-stu-id="b6f64-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="b6f64-173">Ancora creato la classe di eccezione, pertanto questo codice non verrà compilato.</span><span class="sxs-lookup"><span data-stu-id="b6f64-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="b6f64-174">Per far sì che la compilazione, fare doppio clic su `DuplicateAdministratorException` e selezionare **genera**e quindi **classe**.</span><span class="sxs-lookup"><span data-stu-id="b6f64-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="b6f64-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="b6f64-176">Viene creata una classe nel progetto di test che è possibile eliminare dopo aver creato la classe di eccezione nel progetto principale.</span><span class="sxs-lookup"><span data-stu-id="b6f64-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="b6f64-177">e implementare la logica di business.</span><span class="sxs-lookup"><span data-stu-id="b6f64-177">and implemented the business logic.</span></span>

<span data-ttu-id="b6f64-178">Eseguire il progetto di test.</span><span class="sxs-lookup"><span data-stu-id="b6f64-178">Run the test project.</span></span> <span data-ttu-id="b6f64-179">Come previsto, superati.</span><span class="sxs-lookup"><span data-stu-id="b6f64-179">As expected, the tests fail.</span></span>

<span data-ttu-id="b6f64-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="b6f64-181">Aggiunta di logica di Business in modo che passi del Test</span><span class="sxs-lookup"><span data-stu-id="b6f64-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="b6f64-182">Verrà quindi implementare la logica di business che rende impossibile impostato come amministratore di un reparto, un utente è già amministratore di un altro reparto.</span><span class="sxs-lookup"><span data-stu-id="b6f64-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="b6f64-183">Verranno genera un'eccezione dal livello di logica di business e quindi viene rilevato nel livello di presentazione se un utente modifica un reparto e fa clic su **aggiornamento** dopo aver selezionato un utente è già un amministratore.</span><span class="sxs-lookup"><span data-stu-id="b6f64-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="b6f64-184">(È anche possibile rimuovere i docenti nell'elenco a discesa che sono già amministratori prima che si esegue il rendering della pagina, ma in questo caso lo scopo è usare il livello di logica di business).</span><span class="sxs-lookup"><span data-stu-id="b6f64-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="b6f64-185">Iniziare creando la classe di eccezione che sarà generata quando un utente tenta di stabilire un docente l'amministratore di più di un reparto.</span><span class="sxs-lookup"><span data-stu-id="b6f64-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="b6f64-186">Il progetto principale, creare un nuovo file di classe nel *BLL* cartella, il nome *DuplicateAdministratorException.cs*e sostituire il codice esistente con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="b6f64-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="b6f64-187">Ora di eliminazione temporanea *DuplicateAdministratorException.cs* file creato nel progetto di test in precedenza per poter essere in grado di compilare.</span><span class="sxs-lookup"><span data-stu-id="b6f64-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="b6f64-188">Il progetto principale, aprire il *SchoolBL.cs* file e aggiungere il metodo seguente che contiene la logica di convalida.</span><span class="sxs-lookup"><span data-stu-id="b6f64-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="b6f64-189">(Il codice fa riferimento a un metodo che verrà creato in un secondo momento).</span><span class="sxs-lookup"><span data-stu-id="b6f64-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="b6f64-190">Si verrà chiamato questo metodo quando si è l'inserimento o aggiornamento `Department` entità per verificare se un altro reparto ha già lo stesso di amministratore.</span><span class="sxs-lookup"><span data-stu-id="b6f64-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="b6f64-191">Il codice chiama un metodo per eseguire ricerche nel database per un `Department` entità che ha lo stesso `Administrator` valore della proprietà dell'entità che viene inserito o aggiornato.</span><span class="sxs-lookup"><span data-stu-id="b6f64-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="b6f64-192">Se viene trovata, il codice genera un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="b6f64-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="b6f64-193">Nessun controllo di convalida è necessaria se l'entità che viene inserito o aggiornato non ha alcun `Administrator` valore e non l'eccezione viene generata se il metodo viene chiamato durante un aggiornamento e `Department` entità trovare corrispondenze il `Department` entità da aggiornare.</span><span class="sxs-lookup"><span data-stu-id="b6f64-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="b6f64-194">Il nuovo metodo da chiamare il `Insert` e `Update` metodi:</span><span class="sxs-lookup"><span data-stu-id="b6f64-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="b6f64-195">In *ISchoolRepository.cs*, aggiungere la seguente dichiarazione per il nuovo metodo di accesso ai dati:</span><span class="sxs-lookup"><span data-stu-id="b6f64-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="b6f64-196">In *SchoolRepository.cs*, aggiungere il seguente `using` istruzione:</span><span class="sxs-lookup"><span data-stu-id="b6f64-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="b6f64-197">In *SchoolRepository.cs*, aggiungere il nuovo metodo di accesso ai dati seguenti:</span><span class="sxs-lookup"><span data-stu-id="b6f64-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="b6f64-198">Questo codice viene recuperato `Department` le entità che dispongono di un amministratore specificato.</span><span class="sxs-lookup"><span data-stu-id="b6f64-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="b6f64-199">(Se presente) deve trovare un solo reparto.</span><span class="sxs-lookup"><span data-stu-id="b6f64-199">Only one department should be found (if any).</span></span> <span data-ttu-id="b6f64-200">Tuttavia, poiché nessun vincolo viene compilato nel database, il tipo restituito è una raccolta nel caso in cui vengono trovati più reparti.</span><span class="sxs-lookup"><span data-stu-id="b6f64-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="b6f64-201">Per impostazione predefinita, quando il contesto dell'oggetto consente di recuperare entità dal database, tiene traccia di essi nella gestione dello stato degli oggetti.</span><span class="sxs-lookup"><span data-stu-id="b6f64-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="b6f64-202">Il `MergeOption.NoTracking` parametro specifica che questo rilevamento non verrà eseguito per questa query.</span><span class="sxs-lookup"><span data-stu-id="b6f64-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="b6f64-203">Ciò è necessario perché la query potrebbe restituire l'entità esatto che si sta tentando di aggiornare e quindi non sarebbe in grado di connettersi a tale entità.</span><span class="sxs-lookup"><span data-stu-id="b6f64-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="b6f64-204">Ad esempio, se si modifica il reparto di cronologia di *Departments.aspx* pagina e lasciare invariato l'amministratore, questa query restituirà il reparto di cronologia.</span><span class="sxs-lookup"><span data-stu-id="b6f64-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="b6f64-205">Se `NoTracking` non è impostata, il contesto dell'oggetto già avrebbe all'entità reparto cronologia nella console di gestione dello stato relativo oggetto.</span><span class="sxs-lookup"><span data-stu-id="b6f64-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="b6f64-206">Quindi quando si collega all'entità reparto cronologia che viene ricreato dallo stato di visualizzazione, genera un'eccezione che indica il contesto dell'oggetto `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span><span class="sxs-lookup"><span data-stu-id="b6f64-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="b6f64-207">(Come un'alternativa alla specifica `MergeOption.NoTracking`, è possibile creare un nuovo contesto di oggetto per questa query.</span><span class="sxs-lookup"><span data-stu-id="b6f64-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="b6f64-208">Perché il nuovo contesto dell'oggetto ha un proprio gestore degli stati di oggetto, non vi sarà alcun conflitto quando si chiama il `Attach` metodo.</span><span class="sxs-lookup"><span data-stu-id="b6f64-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="b6f64-209">Il nuovo contesto dell'oggetto condividerebbero connessione di database e i metadati con il contesto di oggetto originale, quindi la riduzione delle prestazioni di questo approccio alternativo devono essere minimo.</span><span class="sxs-lookup"><span data-stu-id="b6f64-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="b6f64-210">L'approccio illustrato di seguito, tuttavia, introduce la `NoTracking` opzione sono disponibili utili in altri contesti.</span><span class="sxs-lookup"><span data-stu-id="b6f64-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="b6f64-211">Il `NoTracking` verrà discusso più avanti in un'esercitazione successiva di questa serie.)</span><span class="sxs-lookup"><span data-stu-id="b6f64-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="b6f64-212">Nel progetto di test, aggiungere il nuovo metodo di accesso ai dati per *MockSchoolRepository.cs*:</span><span class="sxs-lookup"><span data-stu-id="b6f64-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="b6f64-213">Questo codice Usa LINQ per eseguire la stessa selezione di dati che il `ContosoUniversity` repository progetto usa LINQ to Entities per.</span><span class="sxs-lookup"><span data-stu-id="b6f64-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="b6f64-214">Eseguire nuovamente il progetto di test.</span><span class="sxs-lookup"><span data-stu-id="b6f64-214">Run the test project again.</span></span> <span data-ttu-id="b6f64-215">Questa volta il test ha esito positivo.</span><span class="sxs-lookup"><span data-stu-id="b6f64-215">This time the tests pass.</span></span>

<span data-ttu-id="b6f64-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="b6f64-217">Gestione delle eccezioni ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="b6f64-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="b6f64-218">Nel `ContosoUniversity` progetto, eseguire il *Departments.aspx* pagina e provare a modificare l'amministratore di un reparto a un utente è già amministratore per un altro reparto.</span><span class="sxs-lookup"><span data-stu-id="b6f64-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="b6f64-219">(Tenere presente che è possibile modificare solo i reparti aggiunto durante questa esercitazione, poiché il database proviene precaricato con dati non validi). Ottenere la pagina di errore server seguenti:</span><span class="sxs-lookup"><span data-stu-id="b6f64-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="b6f64-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="b6f64-221">Non si desidera che gli utenti visualizzino questo tipo di pagina di errore, pertanto è necessario aggiungere il codice di gestione degli errori.</span><span class="sxs-lookup"><span data-stu-id="b6f64-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="b6f64-222">Aprire *Departments.aspx* e specificare un gestore per il `OnUpdated` evento del `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="b6f64-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="b6f64-223">Il `ObjectDataSource` tag di apertura ora simile all'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="b6f64-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="b6f64-224">In *Departments.aspx.cs*, aggiungere il seguente `using` istruzione:</span><span class="sxs-lookup"><span data-stu-id="b6f64-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="b6f64-225">Aggiungere il seguente gestore per il `Updated` evento:</span><span class="sxs-lookup"><span data-stu-id="b6f64-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="b6f64-226">Se il `ObjectDataSource` controllo rileva un'eccezione quando tenta di eseguire l'aggiornamento, passa l'eccezione nell'argomento dell'evento (`e`) a questo gestore.</span><span class="sxs-lookup"><span data-stu-id="b6f64-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="b6f64-227">Il codice nel gestore di verifica per verificare se l'eccezione è l'eccezione amministratore duplicati.</span><span class="sxs-lookup"><span data-stu-id="b6f64-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="b6f64-228">Questo caso, il codice crea un controllo di convalida che contiene un messaggio di errore per il `ValidationSummary` controllo da visualizzare.</span><span class="sxs-lookup"><span data-stu-id="b6f64-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="b6f64-229">Eseguire la pagina e tenta di rendere un utente amministratore due reparti nuovamente.</span><span class="sxs-lookup"><span data-stu-id="b6f64-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="b6f64-230">Questa volta il `ValidationSummary` controllo Visualizza un messaggio di errore.</span><span class="sxs-lookup"><span data-stu-id="b6f64-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="b6f64-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="b6f64-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="b6f64-232">Apportare modifiche simili per il *DepartmentsAdd.aspx* pagina.</span><span class="sxs-lookup"><span data-stu-id="b6f64-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="b6f64-233">In *DepartmentsAdd.aspx*, specificare un gestore per il `OnInserted` evento del `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="b6f64-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="b6f64-234">Il tag risulta sarà simile all'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="b6f64-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="b6f64-235">In *DepartmentsAdd.aspx.cs*, aggiungere la stessa `using` istruzione:</span><span class="sxs-lookup"><span data-stu-id="b6f64-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="b6f64-236">Aggiungere il seguente gestore eventi:</span><span class="sxs-lookup"><span data-stu-id="b6f64-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="b6f64-237">È ora possibile testare il *DepartmentsAdd.aspx.cs* pagina per verificare che gestisce anche correttamente tenta di rendere l'amministratore del più reparto di una persona.</span><span class="sxs-lookup"><span data-stu-id="b6f64-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="b6f64-238">Questo completa l'introduzione di implementazione del modello di repository per l'utilizzo di `ObjectDataSource` controllo con Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="b6f64-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="b6f64-239">Per ulteriori informazioni sul modello di repository e testabilità, vedere il white paper MSDN [testabilità ed Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span><span class="sxs-lookup"><span data-stu-id="b6f64-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="b6f64-240">Nell'esercitazione seguente si noterà come aggiungere l'ordinamento e filtro funzionalità all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="b6f64-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="b6f64-241">[Precedente](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Successivo](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="b6f64-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
