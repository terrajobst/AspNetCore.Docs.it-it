---
title: Gestione e durata delle chiavi di protezione dei dati in ASP.NET Core
author: rick-anderson
description: Informazioni sulla gestione e la durata delle chiavi di protezione dei dati in ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/configuration/default-settings
ms.openlocfilehash: 2f022a4c7519485fe629ce47c27d214c8c27d5bc
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/06/2020
ms.locfileid: "78667965"
---
# <a name="data-protection-key-management-and-lifetime-in-aspnet-core"></a><span data-ttu-id="a8722-103">Gestione e durata delle chiavi di protezione dei dati in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="a8722-103">Data Protection key management and lifetime in ASP.NET Core</span></span>

<span data-ttu-id="a8722-104">Di [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="a8722-104">By [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

## <a name="key-management"></a><span data-ttu-id="a8722-105">Gestione delle chiavi</span><span class="sxs-lookup"><span data-stu-id="a8722-105">Key management</span></span>

<span data-ttu-id="a8722-106">L'app tenta di rilevare il proprio ambiente operativo e gestire la configurazione della chiave autonomamente.</span><span class="sxs-lookup"><span data-stu-id="a8722-106">The app attempts to detect its operational environment and handle key configuration on its own.</span></span>

1. <span data-ttu-id="a8722-107">Se l'app è ospitata in [app di Azure](https://azure.microsoft.com/services/app-service/), le chiavi vengono salvate in modo permanente nella cartella *%Home%\ASP.NET\DataProtection-Keys* .</span><span class="sxs-lookup"><span data-stu-id="a8722-107">If the app is hosted in [Azure Apps](https://azure.microsoft.com/services/app-service/), keys are persisted to the *%HOME%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="a8722-108">La cartella è associata all'archiviazione di rete e sincronizzata in tutti i computer che ospitano l'app.</span><span class="sxs-lookup"><span data-stu-id="a8722-108">This folder is backed by network storage and is synchronized across all machines hosting the app.</span></span>
   * <span data-ttu-id="a8722-109">Le chiavi non vengono protette quando sono inattive.</span><span class="sxs-lookup"><span data-stu-id="a8722-109">Keys aren't protected at rest.</span></span>
   * <span data-ttu-id="a8722-110">La cartella *DataProtection-Keys* fornisce l'anello chiave a tutte le istanze di un'app in un unico slot di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="a8722-110">The *DataProtection-Keys* folder supplies the key ring to all instances of an app in a single deployment slot.</span></span>
   * <span data-ttu-id="a8722-111">Gli slot di distribuzione separati, ad esempio gli slot di gestione temporanea e di produzione, non condividono un KeyRing.</span><span class="sxs-lookup"><span data-stu-id="a8722-111">Separate deployment slots, such as Staging and Production, don't share a key ring.</span></span> <span data-ttu-id="a8722-112">Quando si esegue lo scambio tra gli slot di distribuzione, ad esempio lo scambio di staging in produzione o l'uso di un test A/B, qualsiasi app che usa la protezione dei dati non sarà in grado di decrittografare i dati archiviati usando l'anello chiave all'interno dello slot precedente.</span><span class="sxs-lookup"><span data-stu-id="a8722-112">When you swap between deployment slots, for example swapping Staging to Production or using A/B testing, any app using Data Protection won't be able to decrypt stored data using the key ring inside the previous slot.</span></span> <span data-ttu-id="a8722-113">In questo modo gli utenti vengono disconnessi da un'app che usa l'autenticazione ASP.NET Core cookie standard, perché usa la protezione dei dati per proteggere i cookie.</span><span class="sxs-lookup"><span data-stu-id="a8722-113">This leads to users being logged out of an app that uses the standard ASP.NET Core cookie authentication, as it uses Data Protection to protect its cookies.</span></span> <span data-ttu-id="a8722-114">Se si vuole che gli anelli chiave indipendenti dallo slot, usare un provider di anello chiave esterno, ad esempio archiviazione BLOB di Azure, Azure Key Vault, un archivio SQL o cache Redis.</span><span class="sxs-lookup"><span data-stu-id="a8722-114">If you desire slot-independent key rings, use an external key ring provider, such as Azure Blob Storage, Azure Key Vault, a SQL store, or Redis cache.</span></span>

1. <span data-ttu-id="a8722-115">Se il profilo utente è disponibile, le chiavi vengono salvate in modo permanente nella cartella *%LocalAppData%\ASP.NET\DataProtection-Keys* .</span><span class="sxs-lookup"><span data-stu-id="a8722-115">If the user profile is available, keys are persisted to the *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="a8722-116">Se il sistema operativo è Windows, le chiavi vengono crittografate a riposo tramite DPAPI.</span><span class="sxs-lookup"><span data-stu-id="a8722-116">If the operating system is Windows, the keys are encrypted at rest using DPAPI.</span></span>

   <span data-ttu-id="a8722-117">Deve essere abilitato anche l'[attributo setProfileEnvironment](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) del pool di app.</span><span class="sxs-lookup"><span data-stu-id="a8722-117">The app pool's [setProfileEnvironment attribute](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) must also be enabled.</span></span> <span data-ttu-id="a8722-118">Il valore predefinito di `setProfileEnvironment` è `true`.</span><span class="sxs-lookup"><span data-stu-id="a8722-118">The default value of `setProfileEnvironment` is `true`.</span></span> <span data-ttu-id="a8722-119">In alcuni scenari (ad esempio, per il sistema operativo Windows), `setProfileEnvironment` è impostato su `false`.</span><span class="sxs-lookup"><span data-stu-id="a8722-119">In some scenarios (for example, Windows OS), `setProfileEnvironment` is set to `false`.</span></span> <span data-ttu-id="a8722-120">Se le chiavi non vengono archiviate nella directory del profilo utente come previsto:</span><span class="sxs-lookup"><span data-stu-id="a8722-120">If keys aren't stored in the user profile directory as expected:</span></span>

   1. <span data-ttu-id="a8722-121">Passare alla cartella *%windir%/system32/inetsrv/config*.</span><span class="sxs-lookup"><span data-stu-id="a8722-121">Navigate to the *%windir%/system32/inetsrv/config* folder.</span></span>
   1. <span data-ttu-id="a8722-122">Aprire il file *applicationHost.config*.</span><span class="sxs-lookup"><span data-stu-id="a8722-122">Open the *applicationHost.config* file.</span></span>
   1. <span data-ttu-id="a8722-123">Individuare l'elemento `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>`.</span><span class="sxs-lookup"><span data-stu-id="a8722-123">Locate the `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>` element.</span></span>
   1. <span data-ttu-id="a8722-124">Verificare che l'attributo `setProfileEnvironment` non sia presente, condizione che corrisponde all'impostazione predefinita `true`, o impostare in modo esplicito il valore dell'attributo su `true`.</span><span class="sxs-lookup"><span data-stu-id="a8722-124">Confirm that the `setProfileEnvironment` attribute isn't present, which defaults the value to `true`, or explicitly set the attribute's value to `true`.</span></span>

1. <span data-ttu-id="a8722-125">Se l'app è ospitata in IIS, le chiavi vengono salvate in modo permanente nel registro di sistema HKLM in una chiave del registro di sistema speciale ACL solo per l'account del processo di lavoro.</span><span class="sxs-lookup"><span data-stu-id="a8722-125">If the app is hosted in IIS, keys are persisted to the HKLM registry in a special registry key that's ACLed only to the worker process account.</span></span> <span data-ttu-id="a8722-126">Le chiavi vengono crittografate a riposo tramite la DPAPI.</span><span class="sxs-lookup"><span data-stu-id="a8722-126">Keys are encrypted at rest using DPAPI.</span></span>

1. <span data-ttu-id="a8722-127">Se nessuna di queste condizioni corrisponde, le chiavi non vengono rese permanente all'esterno del processo corrente.</span><span class="sxs-lookup"><span data-stu-id="a8722-127">If none of these conditions match, keys aren't persisted outside of the current process.</span></span> <span data-ttu-id="a8722-128">Quando il processo viene arrestato, vengono perse tutte le chiavi generate.</span><span class="sxs-lookup"><span data-stu-id="a8722-128">When the process shuts down, all generated keys are lost.</span></span>

<span data-ttu-id="a8722-129">Lo sviluppatore è sempre in controllo completo ed è in grado di ignorare come e dove vengono archiviate le chiavi.</span><span class="sxs-lookup"><span data-stu-id="a8722-129">The developer is always in full control and can override how and where keys are stored.</span></span> <span data-ttu-id="a8722-130">Le prime tre opzioni precedenti dovrebbero fornire impostazioni predefinite valide per la maggior parte delle app, in modo analogo a come il ASP.NET **\<machineKey >** routine di generazione automatica hanno funzionato in passato.</span><span class="sxs-lookup"><span data-stu-id="a8722-130">The first three options above should provide good defaults for most apps similar to how the ASP.NET **\<machineKey>** auto-generation routines worked in the past.</span></span> <span data-ttu-id="a8722-131">L'opzione finale fallback è l'unico scenario in cui è necessario che lo sviluppatore specifichi la [configurazione](xref:security/data-protection/configuration/overview) iniziale se desidera la persistenza della chiave, ma questo fallback si verifica solo in rari casi.</span><span class="sxs-lookup"><span data-stu-id="a8722-131">The final, fallback option is the only scenario that requires the developer to specify [configuration](xref:security/data-protection/configuration/overview) upfront if they want key persistence, but this fallback only occurs in rare situations.</span></span>

<span data-ttu-id="a8722-132">Quando si esegue l'hosting in un contenitore Docker, le chiavi devono essere rese permanente in una cartella che è un volume Docker (un volume condiviso o un volume montato dall'host che è permanente oltre la durata del contenitore) o in un provider esterno, ad esempio [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) o [Redis](https://redis.io/).</span><span class="sxs-lookup"><span data-stu-id="a8722-132">When hosting in a Docker container, keys should be persisted in a folder that's a Docker volume (a shared volume or a host-mounted volume that persists beyond the container's lifetime) or in an external provider, such as [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) or [Redis](https://redis.io/).</span></span> <span data-ttu-id="a8722-133">Un provider esterno è utile anche negli scenari Web farm se le app non possono accedere a un volume di rete condiviso. per ulteriori informazioni, vedere [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) .</span><span class="sxs-lookup"><span data-stu-id="a8722-133">An external provider is also useful in web farm scenarios if apps can't access a shared network volume (see [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) for more information).</span></span>

> [!WARNING]
> <span data-ttu-id="a8722-134">Se lo sviluppatore sostituisce le regole descritte in precedenza e fa riferimento al sistema di protezione dei dati in un repository di chiavi specifico, la crittografia automatica delle chiavi inattive è disabilitata.</span><span class="sxs-lookup"><span data-stu-id="a8722-134">If the developer overrides the rules outlined above and points the Data Protection system at a specific key repository, automatic encryption of keys at rest is disabled.</span></span> <span data-ttu-id="a8722-135">La protezione dati inattiva può essere riabilitata tramite la [configurazione](xref:security/data-protection/configuration/overview).</span><span class="sxs-lookup"><span data-stu-id="a8722-135">At-rest protection can be re-enabled via [configuration](xref:security/data-protection/configuration/overview).</span></span>

## <a name="key-lifetime"></a><span data-ttu-id="a8722-136">Durata della chiave</span><span class="sxs-lookup"><span data-stu-id="a8722-136">Key lifetime</span></span>

<span data-ttu-id="a8722-137">Per impostazione predefinita, le chiavi hanno una durata di 90 giorni.</span><span class="sxs-lookup"><span data-stu-id="a8722-137">Keys have a 90-day lifetime by default.</span></span> <span data-ttu-id="a8722-138">Quando una chiave scade, l'app genera automaticamente una nuova chiave e imposta la nuova chiave come chiave attiva.</span><span class="sxs-lookup"><span data-stu-id="a8722-138">When a key expires, the app automatically generates a new key and sets the new key as the active key.</span></span> <span data-ttu-id="a8722-139">Fino a quando le chiavi ritirate rimangono nel sistema, l'app può decrittografare i dati protetti con essi.</span><span class="sxs-lookup"><span data-stu-id="a8722-139">As long as retired keys remain on the system, your app can decrypt any data protected with them.</span></span> <span data-ttu-id="a8722-140">Per ulteriori informazioni, vedere [gestione delle chiavi](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) .</span><span class="sxs-lookup"><span data-stu-id="a8722-140">See [key management](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) for more information.</span></span>

## <a name="default-algorithms"></a><span data-ttu-id="a8722-141">Algoritmi predefiniti</span><span class="sxs-lookup"><span data-stu-id="a8722-141">Default algorithms</span></span>

<span data-ttu-id="a8722-142">L'algoritmo di protezione del payload predefinito usato è AES-256-CBC per la riservatezza e HMACSHA256 per l'autenticità.</span><span class="sxs-lookup"><span data-stu-id="a8722-142">The default payload protection algorithm used is AES-256-CBC for confidentiality and HMACSHA256 for authenticity.</span></span> <span data-ttu-id="a8722-143">Una chiave master a 512 bit, modificata ogni 90 giorni, viene usata per derivare le due sottochiavi usate per questi algoritmi in base al payload.</span><span class="sxs-lookup"><span data-stu-id="a8722-143">A 512-bit master key, changed every 90 days, is used to derive the two sub-keys used for these algorithms on a per-payload basis.</span></span> <span data-ttu-id="a8722-144">Per ulteriori informazioni, vedere [derivazione della sottochiave](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) .</span><span class="sxs-lookup"><span data-stu-id="a8722-144">See [subkey derivation](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) for more information.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="a8722-145">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="a8722-145">Additional resources</span></span>

* <xref:security/data-protection/extensibility/key-management>
* <xref:host-and-deploy/web-farm>
